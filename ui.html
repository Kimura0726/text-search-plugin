<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <style>
      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        margin: 0;
        padding: 16px;
        background: #ffffff;
        font-size: 12px;
        line-height: 1.5;
      }

      .search-container {
        margin-bottom: 16px;
      }

      .search-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #e5e5e5;
        border-radius: 4px;
        font-size: 14px;
        font-family: inherit;
        box-sizing: border-box;
      }

      .search-input:focus {
        outline: none;
        border-color: #18a0fb;
        box-shadow: 0 0 0 2px rgba(24, 160, 251, 0.2);
      }

      .search-button {
        width: 100%;
        padding: 8px 12px;
        margin-top: 8px;
        background: #18a0fb;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        font-family: inherit;
        cursor: pointer;
      }

      .search-button:hover {
        background: #1785d1;
      }

      .search-button:disabled {
        background: #c4c4c4;
        cursor: not-allowed;
      }

      .results-container {
        margin-top: 16px;
        max-height: 450px;
        overflow-y: auto;
      }

      .result-item {
        padding: 12px;
        margin-bottom: 8px;
        border: 1px solid #e5e5e5;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .result-item:hover {
        background-color: #f5f5f5;
      }

      .result-page {
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
      }

      .result-node {
        color: #666;
        font-size: 11px;
        margin-bottom: 4px;
      }

      .result-text {
        color: #333;
        font-size: 12px;
        background-color: #f8f8f8;
        padding: 4px 6px;
        border-radius: 3px;
        word-wrap: break-word;
        max-height: 60px;
        overflow: hidden;
      }

      .result-coordinates {
        color: #999;
        font-size: 10px;
        margin-top: 4px;
      }

      .no-results {
        text-align: center;
        color: #666;
        margin-top: 32px;
        font-style: italic;
      }

      .results-count {
        color: #666;
        font-size: 11px;
        margin-bottom: 12px;
      }

      .highlight {
        background-color: #fff3cd;
        padding: 1px 2px;
        border-radius: 2px;
      }

      .close-button {
        position: absolute;
        top: 8px;
        right: 8px;
        background: none;
        border: none;
        font-size: 16px;
        cursor: pointer;
        color: #666;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 3px;
      }

      .close-button:hover {
        background-color: #f0f0f0;
      }
    </style>
  </head>
  <body>
    <button class="close-button" id="close-btn">×</button>

    <div class="search-container">
      <input
        type="text"
        class="search-input"
        id="searchInput"
        placeholder="検索したいテキストを入力..."
      />
      <button class="search-button" id="searchButton">検索</button>
    </div>

    <div class="results-container" id="resultsContainer">
      <div class="no-results" id="initialMessage">
        テキストを入力して検索を開始してください
      </div>
    </div>

    <script>
      const searchInput = document.getElementById("searchInput");
      const searchButton = document.getElementById("searchButton");
      const resultsContainer = document.getElementById("resultsContainer");
      const initialMessage = document.getElementById("initialMessage");
      const closeBtn = document.getElementById("close-btn");

      let currentResults = [];

      // 検索実行
      function executeSearch() {
        const query = searchInput.value.trim();
        if (!query) return;

        searchButton.disabled = true;
        searchButton.textContent = "検索中...";

        parent.postMessage(
          {
            pluginMessage: {
              type: "search-text",
              query: query,
            },
          },
          "*"
        );
      }

      // イベントリスナー
      searchButton.addEventListener("click", executeSearch);

      searchInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          executeSearch();
        }
      });

      closeBtn.addEventListener("click", () => {
        parent.postMessage(
          {
            pluginMessage: {
              type: "close-plugin",
            },
          },
          "*"
        );
      });

      // 検索結果の表示
      function displayResults(results, query) {
        currentResults = results;
        resultsContainer.innerHTML = "";

        if (results.length === 0) {
          resultsContainer.innerHTML = `
                    <div class="no-results">
                        "${query}" に一致するテキストが見つかりませんでした
                    </div>
                `;
          return;
        }

        // 結果数の表示
        const countDiv = document.createElement("div");
        countDiv.className = "results-count";
        countDiv.textContent = `${results.length} 件の結果が見つかりました`;
        resultsContainer.appendChild(countDiv);

        // 各結果の表示
        results.forEach((result, index) => {
          const resultItem = document.createElement("div");
          resultItem.className = "result-item";

          // テキストのハイライト
          const highlightedText = highlightQuery(result.text, query);

          resultItem.innerHTML = `
                    <div class="result-page">${escapeHtml(
                      result.pageName
                    )}</div>
                    <div class="result-node">ノード: ${escapeHtml(
                      result.nodeName
                    )}</div>
                    <div class="result-text">${highlightedText}</div>
                    <div class="result-coordinates">位置: (${Math.round(
                      result.x
                    )}, ${Math.round(result.y)})</div>
                `;

          resultItem.addEventListener("click", () => {
            parent.postMessage(
              {
                pluginMessage: {
                  type: "navigate-to-node",
                  pageId: result.pageId,
                  nodeId: result.nodeId,
                },
              },
              "*"
            );
          });

          resultsContainer.appendChild(resultItem);
        });
      }

      // クエリをハイライト
      function highlightQuery(text, query) {
        const escapedText = escapeHtml(text);
        const escapedQuery = escapeHtml(query);
        const regex = new RegExp(`(${escapedQuery})`, "gi");
        return escapedText.replace(regex, '<span class="highlight">$1</span>');
      }

      // HTMLエスケープ
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // プラグインからのメッセージを受信
      window.onmessage = (event) => {
        const msg = event.data.pluginMessage;

        if (msg.type === "search-results") {
          searchButton.disabled = false;
          searchButton.textContent = "検索";
          displayResults(msg.results, msg.query);
        }
      };

      // 初期フォーカス
      searchInput.focus();
    </script>
  </body>
</html>
